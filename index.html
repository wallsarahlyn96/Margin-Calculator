<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGIP Redline Profit Calculator (Installer)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1d39; --ink:#e8eeff; --muted:#9fb2d9; --line:#1e2b4d;
      --brand:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#050914,#0f1830);color:var(--ink);}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    .section-title{font-size:12px;letter-spacing:1.3px;color:var(--muted);text-transform:uppercase;margin:2px 0 10px}
    .row{display:grid;grid-template-columns:1fr 210px;gap:10px;align-items:center;margin:8px 0}
    @media(max-width:560px){.row{grid-template-columns:1fr}}
    label{font-size:14px;color:#d7e4ff}
    input,select,button{width:100%;padding:10px 12px;border:1px solid #223258;background:#0b1734;color:#e8eeff;border-radius:10px;font-size:15px}
    .hint{font-size:12px;color:var(--muted);margin-top:2px}
    .btn{background:linear-gradient(135deg,#2563eb,#1d4ed8);border:0;color:white;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:#0b1734;border:1px solid var(--line);cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media(max-width:900px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#0b1734;border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px}
    .kpi .value{margin-top:4px;font-size:22px;font-weight:800}
    .sub{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--danger)} .warn{color:var(--warn)}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill{padding:6px 10px;border-radius:999px;background:#0b1734;border:1px solid var(--line);font-size:13px}
    .row-inline{display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SGIP Redline Profit Calculator (Installer)</h1>
    <div class="grid">
      <div class="card">
        <div class="section-title">Inputs</div>

        <div class="row">
          <label>System Size (kW-DC)</label>
          <input type="number" id="kw" value="8" min="0" step="0.1">
        </div>
        <div class="row">
          <label>Redline ($/W)</label>
          <input type="number" id="redlinePerW" value="2.50" min="0" step="0.01">
        </div>
        <div class="row">
          <label>Sales Rep Commission ($/W)</label>
          <input type="number" id="salesPerW" value="0.50" min="0" step="0.01">
        </div>

        <div class="row">
          <label>Battery Count</label>
          <input type="number" id="batts" value="3" min="0" step="1">
        </div>
        <div class="row">
          <label>kWh per Battery</label>
          <input type="number" id="kwhPerBatt" value="9.7" min="0" step="0.1">
        </div>

        <div class="row">
          <label>SGIP Solar Rate ($/W)</label>
          <input type="number" id="sgipSolarPerW" value="3.10" min="0" step="0.01">
        </div>
        <div class="row">
          <label>SGIP Storage Rate ($/kWh)</label>
          <input type="number" id="sgipStoragePerKWh" value="1100" min="0" step="1">
        </div>

        <!-- TEPC is auto = $5.50/W + $1,400/batt, but editable -->
        <div class="row">
          <label>TEPC Amount ($)</label>
          <input type="number" id="tepcAmount" value="0" min="0" step="100">
          <div class="hint">Auto = $5.50/W + $1,400 per battery (editable)</div>
        </div>

        <div class="row">
          <label>PPA Enabled?</label>
          <select id="ppaEnabled">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>

        <div class="row">
          <label>PPA Amount ($)</label>
          <div class="row-inline">
            <input type="number" id="ppaAmount" value="0" min="0" step="100">
            <button id="ppaAutoBtn" class="btn-ghost">Auto‑fill</button>
          </div>
          <div class="hint">Sets to $5.50/W + $1,400 per battery (still editable)</div>
        </div>

        <div class="stack">
          <button class="btn" id="run">Run Calculator</button>
          <span class="pill">Profit = (SGIP − Redline − Sales Comm) + 30% of TEPC + PPA kicker</span>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Financial Summary</div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Redline Total</div>
            <div class="value" id="kRedline">$0</div>
            <div class="sub" id="kRedlineSub"></div>
          </div>
          <div class="kpi">
            <div class="label">SGIP Approved</div>
            <div class="value" id="kSGIP">$0</div>
            <div class="sub" id="kSGIPSub"></div>
          </div>
          <div class="kpi">
            <div class="label">Sales Commission</div>
            <div class="value" id="kSales">$0</div>
            <div class="sub" id="kSalesSub"></div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">TEPC Used</div>
            <div class="value" id="kTEPC">$0</div>
            <div class="sub" id="kTEPCSub"></div>
          </div>
          <div class="kpi">
            <div class="label">ITC Value (30%)</div>
            <div class="value" id="kITC">$0</div>
            <div class="sub" id="kITCSub"></div>
          </div>
          <div class="kpi">
            <div class="label">PPA Kicker</div>
            <div class="value" id="kPPA">$0</div>
            <div class="sub" id="kPPASub"></div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Base Profit (no ITC/PPA)</div>
            <div class="value" id="kBase">$0</div>
            <div class="sub">= SGIP − Redline − Sales Comm</div>
          </div>
          <div class="kpi">
            <div class="label">Total Profit (incl. ITC &amp; PPA)</div>
            <div class="value" id="kTotal">$0</div>
            <div class="sub" id="kTotalSub"></div>
          </div>
          <div class="kpi">
            <div class="label">Notes</div>
            <div class="value" id="kNote" style="font-size:14px;font-weight:600">TEPC auto-filled</div>
            <div class="sub">TEPC = $5.50/W + $1,400/batt (editable)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const money = n => n.toLocaleString(undefined, {style:'currency', currency:'USD', maximumFractionDigits:0});

  // track if user manually edited TEPC so auto-fill won't overwrite it
  let tepcEdited = false;
  $('tepcAmount').addEventListener('input', () => { tepcEdited = true; });

  // Shared formula for TEPC/PPA auto values
  const autoFormula = (watts, batts) => (5.50 * watts) + (1400 * batts);

  function autoFillTEPCIfNeeded(watts, batts){
    if (!tepcEdited){
      const auto = autoFormula(watts, batts);
      $('tepcAmount').value = isFinite(auto) ? Math.round(auto) : 0;
    }
  }

  // PPA Auto-fill button
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('ppaAutoBtn').addEventListener('click', () => {
      const kw = parseFloat($('kw').value)||0;
      const watts = kw * 1000;
      const batts = parseFloat($('batts').value)||0;
      const auto = autoFormula(watts, batts);
      $('ppaAmount').value = isFinite(auto) ? Math.round(auto) : 0;
      calc();
    });
  });

  function calc(){
    const kw = parseFloat($('kw').value)||0;
    const watts = kw * 1000;

    // Redline & Sales
    const redlinePerW = parseFloat($('redlinePerW').value)||0;
    const redlineTotal = redlinePerW * watts;

    const salesPerW = parseFloat($('salesPerW').value)||0;
    const salesComm = salesPerW * watts;

    // Storage & SGIP
    const batts = parseFloat($('batts').value)||0;
    const kwhPerBatt = parseFloat($('kwhPerBatt').value)||0;
    const storageKWh = batts * kwhPerBatt;

    const sgipSolarPerW = parseFloat($('sgipSolarPerW').value)||0;
    const sgipStoragePerKWh = parseFloat($('sgipStoragePerKWh').value)||0;
    const sgipSolar = sgipSolarPerW * watts;
    const sgipStorage = sgipStoragePerKWh * storageKWh;
    const sgipApproved = sgipSolar + sgipStorage;

    // TEPC auto-fill (but respect manual edits)
    autoFillTEPCIfNeeded(watts, batts);
    const tepcUsed = parseFloat($('tepcAmount').value)||0;

    // ITC = 30% of TEPC
    const itcVal = 0.30 * tepcUsed;

    // PPA kicker = 20% of 30% on PPA amount (i.e., 6% of PPA amount)
    const ppaEnabled = $('ppaEnabled').value === 'yes';
    const ppaAmount = parseFloat($('ppaAmount').value)||0;
    const ppaKicker = ppaEnabled ? 0.06 * ppaAmount : 0;

    // Base & Total Profit
    const baseProfit = sgipApproved - redlineTotal - salesComm;
    const totalProfit = baseProfit + itcVal + ppaKicker;

    // --- Outputs ---
    $('kRedline').textContent = money(redlineTotal);
    $('kRedlineSub').textContent = `${kw.toFixed(1)} kW × $${redlinePerW.toFixed(2)}/W`;

    $('kSGIP').textContent = money(sgipApproved);
    $('kSGIPSub').textContent = `Solar: ${money(sgipSolar)} + Storage: ${money(sgipStorage)}`;

    $('kSales').textContent = money(salesComm);
    $('kSalesSub').textContent = `${kw.toFixed(1)} kW × $${salesPerW.toFixed(2)}/W`;

    $('kTEPC').textContent = money(tepcUsed);
    $('kTEPCSub').textContent = tepcEdited ? 'manual edit applied' : 'auto = $5.50/W + $1,400/batt';

    $('kITC').textContent = money(itcVal);
    $('kITCSub').textContent = `30% × TEPC (${money(tepcUsed)})`;

    $('kPPA').textContent = money(ppaKicker);
    $('kPPASub').textContent = ppaEnabled ? '6% of PPA amount' : 'disabled';

    $('kBase').textContent = money(baseProfit);
    $('kBase').className = 'value ' + (baseProfit>=0?'ok':'bad');

    $('kTotal').textContent = money(totalProfit);
    $('kTotal').className = 'value ' + (totalProfit>=0?'ok':'bad');
    $('kTotalSub').textContent = `Base ${money(baseProfit)} + ITC ${money(itcVal)} + PPA ${money(ppaKicker)}`;
  }

  // Recalc on click & when inputs change
  $('run').addEventListener('click', calc);
  ['kw','redlinePerW','salesPerW','batts','kwhPerBatt','sgipSolarPerW','sgipStoragePerKWh','ppaEnabled','tepcAmount','ppaAmount']
    .forEach(id => $(id).addEventListener('input', calc));

  // Initial run
  calc();
</script>
</body>
</html>
