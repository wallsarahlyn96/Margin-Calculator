<script>
  const $ = id => document.getElementById(id);
  const money = n => n.toLocaleString(undefined, {style:'currency', currency:'USD', maximumFractionDigits:0});

  function calc(){
    const kw = parseFloat($('kw').value)||0;
    const watts = kw * 1000;

    // Redline
    const redlinePerW = parseFloat($('redlinePerW').value)||0;
    const redlineTotal = redlinePerW * watts;

    // Sales commission
    const salesPerW = parseFloat($('salesPerW').value)||0;
    const salesComm = salesPerW * watts;

    // Storage
    const batts = parseFloat($('batts').value)||0;
    const kwhPerBatt = parseFloat($('kwhPerBatt').value)||0;
    const storageKWh = batts * kwhPerBatt;

    // SGIP rates
    const sgipSolarPerW = parseFloat($('sgipSolarPerW').value)||0;
    const sgipStoragePerKWh = parseFloat($('sgipStoragePerKWh').value)||0;
    const sgipSolar = sgipSolarPerW * watts;
    const sgipStorage = sgipStoragePerKWh * storageKWh;
    let sgipCalc = sgipSolar + sgipStorage;

    // Manual override for SGIP approved
    const manualSGIP = parseFloat($('manualSGIP').value);
    const sgipApproved = isFinite(manualSGIP) && manualSGIP>0 ? manualSGIP : sgipCalc;

    // ITC = % of SGIP Approved
    const itcPct = (parseFloat($('itcPct').value)||0)/100;
    const itcVal = itcPct * sgipApproved;

    // TEPC = SGIP Approved + ITC
    const tepc = sgipApproved + itcVal;

    // Base profit (no ITC/PPA)
    const baseProfit = sgipApproved - redlineTotal - salesComm;

    // PPA logic: 20% of the total 30% tax credit ON THE PPA AMOUNT
    const ppaEnabled = $('ppaEnabled').value === 'yes';
    const ppaAmount = parseFloat($('ppaAmount').value)||0;
    const ppaITC = 0.30 * ppaAmount;
    const ppaKicker = ppaEnabled ? 0.20 * ppaITC : 0;

    // Final total profit
    const totalProfit = baseProfit + itcVal + ppaKicker;

    // Outputs
    $('kRedline').textContent = money(redlineTotal);
    $('kRedlineSub').textContent = `${kw.toFixed(1)} kW × $${redlinePerW.toFixed(2)}/W`;

    $('kSGIP').textContent = money(sgipApproved);
    $('kSGIPSub').textContent = (isFinite(manualSGIP) && manualSGIP>0)
      ? 'manual override applied'
      : `Solar: ${money(sgipSolar)} + Storage: ${money(sgipStorage)}`;

    $('kSales').textContent = money(salesComm);
    $('kSalesSub').textContent = `${kw.toFixed(1)} kW × $${salesPerW.toFixed(2)}/W`;

    $('kBase').textContent = money(baseProfit);
    $('kBase').className = 'value ' + (baseProfit>=0?'ok':'bad');

    $('kITC').textContent = money(itcVal);
    $('kITCSub').textContent = `${(itcPct*100).toFixed(0)}% × SGIP (${money(sgipApproved)})`;

    $('kPPA').textContent = money(ppaKicker);
    $('kPPASub').textContent = ppaEnabled ? `20% × (30% × ${money(ppaAmount)})` : 'disabled';

    $('kTotal').textContent = money(totalProfit);
    $('kTotal').className = 'value ' + (totalProfit>=0?'ok':'bad');
    $('kTotalSub').textContent = `Base ${money(baseProfit)} + ITC ${money(itcVal)} + PPA ${money(ppaKicker)}`;

    $('kNote').textContent = `TEPC = SGIP (${money(sgipApproved)}) + ITC (${money(itcVal)}) = ${money(tepc)}`;
  }

  $('run').addEventListener('click', calc);
  calc();
</script>
